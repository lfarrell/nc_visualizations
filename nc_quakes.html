<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="d3/d3.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script>
        (window.onload = function() {
            var data = [
                { date: "06 07, 2013", magnitude: 2.3, lat: 35.28, lon: -83.319, location: "42.2 miles from Sevierville" },
                { date: "06 24, 2013", magnitude: 2.1, lat: 35.151, lon: -77.641, location: "8.2 miles from Kinston" },
                { date: "08 25, 2013", magnitude: 2.9, lat: 36.165, lon: -81.667, location: "3.2 miles from Boone" },
                { date: "08 28, 2013", magnitude: 2.1, lat: 35.299, lon: -82.492, location: "2.2 miles from Hendersonville" },
                { date: "12 10, 2013", magnitude: 1.5, lat: 35.276, lon: -83.298, location: "43.2 miles from Sevierville" },
                { date: "02 11, 2014", magnitude: 2.9, lat: 35.296, lon: -76.628, location: "26.2 miles from New Bern" }
            ];

            var data = [
                {"date":"2014-02-11","magnitude":"2.9","lat":"35.2961","lon":"-76.6283","location":"21km NE of Bayboro North Carolina"},
                {"date":"2013-12-10","magnitude":"1.5","lat":"35.2763","lon":"-83.2983","location":"11km WSW of Cullowhee North Carolina"},
                {"date":"2013-08-28","magnitude":"2.1","lat":"35.2986","lon":"-82.4917","location":"0km W of Valley Hill North Carolina"},
                {"date":"2013-08-25","magnitude":"2.9","lat":"36.1645","lon":"-81.6665","location":"3km NNE of Blowing Rock North Carolina"},
                {"date":"2013-06-24","magnitude":"2.1","lat":"35.1506","lon":"-77.6413","location":"13km SSW of Kinston North Carolina"},
                {"date":"2013-06-07","magnitude":"2.3","lat":"35.2931","lon":"-83.3143","location":"11km SW of Sylva  North Carolina"},
                {"date":"2013-06-06","magnitude":"2.5","lat":"35.2895","lon":"-83.3133","location":"12km WSW of Cullowhee  North Carolina"},
                {"date":"2013-06-06","magnitude":"2.5","lat":"35.2868","lon":"-83.31","location":"11km W of Cullowhee  North Carolina"},
                {"date":"2012-10-29","magnitude":"2.9","lat":"35.61","lon":"-82","location":"North Carolina"},
                {"date":"2012-08-21","magnitude":"2.2","lat":"35.709","lon":"-82.851","location":"North Carolina"},
                {"date":"2012-06-20","magnitude":"2.0","lat":"35.274","lon":"-83.332","location":"Tennessee-North Carolina border region"},
                {"date":"2012-03-31","magnitude":"2.2","lat":"35.083","lon":"-80.342","location":"North Carolina"},
                {"date":"2011-01-02","magnitude":"2.5","lat":"35.533","lon":"-83.384","location":"Tennessee-North Carolina border region"},
                {"date":"2009-10-03","magnitude":"2.5","lat":"35.3","lon":"-82.5","location":"North Carolina"},
                {"date":"2007-12-07","magnitude":"3.1","lat":"35.246","lon":"-82.161","location":"North Carolina"},
                {"date":"2007-08-04","magnitude":"3.0","lat":"35.49","lon":"-82.09","location":"North Carolina"},
                {"date":"2006-11-03","magnitude":"2.5","lat":"36.042","lon":"-80.258","location":"Virginia-North Carolina border region"},
                {"date":"2006-10-18","magnitude":"1.3","lat":"36.087","lon":"-80.308","location":"Virginia-North Carolina border region"},
                {"date":"2006-10-18","magnitude":"2.8","lat":"36.101","lon":"-80.303","location":"Virginia-North Carolina border region"},
                {"date":"2006-10-17","magnitude":"1.5","lat":"36.102","lon":"-80.308","location":"Virginia-North Carolina border region"},
                {"date":"2006-10-17","magnitude":"2.9","lat":"36.074","lon":"-80.29","location":"Virginia-North Carolina border region"},
                {"date":"2006-06-16","magnitude":"3.1","lat":"35.515","lon":"-83.229","location":"Tennessee-North Carolina border region"},
                {"date":"2006-03-06","magnitude":"2.8","lat":"35.895","lon":"-82.359","location":"North Carolina"},
                {"date":"2005-12-07","magnitude":"2.8","lat":"35.862","lon":"-82.38","location":"North Carolina"},
                {"date":"2005-08-25","magnitude":"2.5","lat":"35.876","lon":"-82.809","location":"North Carolina"},
                {"date":"2005-08-25","magnitude":"3.6","lat":"35.88","lon":"-82.8","location":"North Carolina"}
            ]

            var margin = {top: 20, right: 15, left: 80, bottom: 80},
                width = 800 - margin.left - margin.right,
                height = 225 - margin.top - margin.bottom,
                map_width = 800, map_height = 350;

            var tooltip = d3.select("body").append("div")
                            .attr("class", "tooltip")
                            .style("opacity", 0);

            var format = d3.time.format("%Y-%m-%d").parse;

            // map
            var projection = d3.geo.mercator()
                    .translate([map_width/4, map_height/4])
                    .center([-80, 35.78])
                    .rotate([2.5, 0])
                    .scale([4800]);
            var path = d3.geo.path().projection(projection);

            d3.select("body").append("div")
                    .attr("id", "map");

            var map = d3.select("#map").append("svg")
                    .attr("width", map_width)
                    .attr("height", map_height)
                    .attr("transform", "translate(0,50)");

            var g = map.append("g");

            d3.json("CountyBoundary84.json", function(topo) {
                g.selectAll("path")
                    .data(topo.features)
                    .enter()
                    .append("path")
                    .attr("d", path);

                g.selectAll("circle")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("cx", function(d) {
                        return projection([d.lon, d.lat])[0]; })
                    .attr("cy", function(d) {
                        return projection([d.lon, d.lat])[1]; })
                    .attr("r", function(d) {
                            return Math.sqrt(d.magnitude) * 5;
                        })
                    .style("fill", "red")
                    .style("opacity", 0.5)
                    .on("mouseover", function(d) {
                        var date_format = format(d.date).toDateString();

                        tooltip.transition()
                            .duration(200)
                            .style("opacity", 0.8);

                        tooltip.html("Magnitude " + d.magnitude +" quake<br/>on " + date_format + "<br/>" + d.location)
                                .style("left", (d3.event.pageX - 28) + "px")
                                .style("top", (d3.event.pageY - 28) + "px");
                    })
                    .on("mouseout", function() {
                        tooltip.transition()
                           .duration(500)
                           .style("opacity", 0);
                    });

            });

            /**
             * Chart
             */


            // Create scales
            var xScale = d3.time.scale()
                    .domain([format("2005-01-01"), d3.max(data, function(d) { return format(d.date); })])
                    .range([0, width]);

            var yScale = d3.scale.linear()
                    .domain([d3.max(data, function(d) { return d.magnitude; }), 0])
                    .range([0, height]);

            // Create Axis
            var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient("bottom")
                .tickFormat(d3.time.format("%b %y"));

            var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient("left");

            var chart = d3.select("body").append("div")
                    .attr("id", "chart");

            var svg = d3.select("#chart").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom);

             svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate("+ margin.left + "," + (height + margin.top) + ")")
                .call(xAxis);

            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom)
                .style("text-anchor", "end")
                .text("Date of Earthquake");

            svg.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                .call(yAxis);

            svg.append("text")
                .attr("transform", "rotate(-90)")
                    .attr("x", -margin.bottom)
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Magnitude");

            svg.append("g")
                .selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("transform", "translate("+ margin.left + "," + margin.top + ")")
                .attr("cx", function(d) { return xScale(format(d.date)); })
                .attr("cy", function(d) { return yScale(d.magnitude); })
                .attr("r", 3.5)
                .style("fill", "steelblue");
        })();
    </script>
    <style>
        .quake {
            fill: none;
        }

        .axis path,
        .axis line {
            fill: none;
            padding: 5px;
            stroke: black;
            shape-rendering: crispEdges;
        }

        path {
            stroke: white;
            stroke-width: 1;
            fill: lightgray;
        }

        #map {
            margin-left: 15%;
            min-height: 400px;
        }

        #chart {
            margin-left: 15%;
            min-height: 250px;
        }

        circle:hover {
            cursor: pointer;
        }

        div.tooltip {
            position: absolute;
            text-align: center;
            width:  auto;
            height: auto;
            padding: 5px;
            fill: black;
            z-index: 9999;
            font: 12px Arial,sans-serif;
            background: whitesmoke;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
    </style>
</head>
<body></body>
</html>